<script>
    var ImgPortrait = '[[name=竖屏图片,width=250,type=textfield,allowblank=true]]';
    var ImgLandscape = '[[name=横屏图片,width=250,type=textfield,allowblank=true]]';
    var Imp = '[[name=第三方监测,type = textfield,allowblank = true,width=250]]';
    var AdName = 'Web App Full Screen AD';
    var AssID = '[ASSID]';

    var gaServerTracker = new Image();
    gaServerTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/2?ec=' + AdName + ' (' + AssID + ')' + '&ea=initiate&el=' + Imp + '&' + Math.random();

    // MARK: - get window width and height
    try {
        w = window.parent.innerWidth || window.parent.document.documentElement.clientWidth || window.parent.document.body.clientWidth;
        h = window.parent.innerHeight || window.parent.document.documentElement.clientHeight || window.parent.document.body.clientHeight;
    } catch (ignore) {
        w = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        h = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
    }
    if (w > h) {
        var newW = w;
        w = h;
        h = newW;
    }

    if (typeof ImgPortrait === 'undefined') {
        ImgLandscape = 'https://www.ft.com/__origami/service/image/v2/images/raw/' + encodeURIComponent(ImgLandscape) + '?source=ftchinese&width=' + 828;
        ImgPortrait = ImgLandscape;
    } else if (typeof ImgLandscape === 'undefined') {
        ImgPortrait = 'https://www.ft.com/__origami/service/image/v2/images/raw/' + encodeURIComponent(ImgPortrait) + '?source=ftchinese&width=' + 828;
        ImgLandscape = ImgPortrait;
    } else {
        ImgPortrait = 'https://www.ft.com/__origami/service/image/v2/images/raw/' + encodeURIComponent(ImgPortrait) + '?source=ftchinese&width=' + 828;
        ImgLandscape = 'https://www.ft.com/__origami/service/image/v2/images/raw/' + encodeURIComponent(ImgLandscape) + '?source=ftchinese&width=' + 828;
    }

    var url = parent.window.location.href;
    if (typeof(url) != 'undefined') {
        (function() {
            var adOpacity = '1';
            var adImage = ImgLandscape;
            var adImage2 = ImgPortrait;
            var adImp = Imp;

            // MARK: Landscape
            var adWidth = h;
            var adHeight = w;

            // MARK: Portrait
            var adWidth2 = w;
            var adHeight2 = h;

            var closeButtonPosition = '';
            var adClass1 = (adWidth < 700) ? 'mobile-landscape' : 'wide-screen';
            var adClass2 = (adWidth < 700) ? 'mobile-portrait' : 'narrow-screen';
            var adCode = '';

            adLink = '[URL]';
            if (adLink.indexOf('?') > 0 && !adLink.indexOf('?http')) {
                adLink += '&isad=1';
            } else {
                adLink += '?isad=1';
            }

            adCode = '<div class=overlayBG style="opacity:' + adOpacity + '"></div><div class=inner><div class=cell><div class="' + adClass1 + '" style="width:' + adWidth + 'px;height:' + adHeight + 'px;margin:auto;position:relative;"><div class="o-overlay__close" style="top:0;right:0;"><div class="o-overlay__close-icon" onclick="closeOverlay()"></div></div><a href="' + adLink + '" target=_blank><div style="width:' + adWidth + 'px;height:' + adHeight + 'px;background-image: url(' + adImage + ');background-repeat: no-repeat;background-size:cover;"></div></a></div><div class="' + adClass2 + '" style="width:' + adWidth2 + 'px;height:' + adHeight2 + 'px;margin:auto;position:relative;"><div class="o-overlay__close" style="top:0;right:0;"><div class="o-overlay__close-icon" onclick="closeOverlay()"></div></div><a href="' + adLink + '" target=_blank><div style="width:' + adWidth2 + 'px;height:' + adHeight2 + 'px;background-image: url(' + adImage2 + ');background-repeat: no-repeat;background-size:cover;"></div></a></div></div>';
            var popAd = parent.parent.document.getElementById("pop-ad");
            var popAdClass = popAd.className;
            var img = new Image();
            img.src = adImage;
            if (popAdClass.indexOf('done') < 0) {
                img.onload = function() {
                    var img2 = new Image();
                    img2.src = adImage2;
                    img2.onload = function() {
                        popAd.innerHTML = adCode;
                        if (popAdClass.indexOf('in-page') < 0) {
                            popAd.className = 'overlay on done';
                            setTimeout(function() {
                                    popAd.className = 'overlay done';
                                    popAd.innerHTML = '';
                                },
                                5000);
                        } else {
                            popAd.className += ' on';
                        }
                    };
                };
            }
        }());

        function sendImpToThirdParty(Imp, AdName, AssID) {
            if (typeof Imp === 'string') {
                if (typeof window.parent.gTrackThirdParyImpression !== 'object') {
                    window.parent.gTrackThirdParyImpression = {};
                }
                var retryTimes = 0;
                var lastImp = Imp;
                var isRequestSuccessful = false;
                var retryTimeLimit = 3;
                var sendEvent = function() {
                    var eventCategory = arguments[0] || '';
                    var eventAction = arguments[1] || '';
                    var eventLabel = arguments[2] || '';
                    try {
                        window.parent.ga('send', 'event', eventCategory, eventAction, eventLabel, {
                            'nonInteraction': 1
                        });
                    } catch (ignore) {
                        var gaServerTracker = new Image();
                        gaServerTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/2?ec=' + eventCategory + '&ea=' + eventAction + '&el=' + eventLabel;
                        if (eventAction === 'request') {
                            var topUrl = top.location.href;
                            var topUrlTracker = new Image();
                            topUrlTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/1?url=' + encodeURIComponent(topUrl);
                        }
                    }
                };
                var sendOnetime = function() {
                    var asRandom = 'IMG' + Math.round(Math.random() * 1000000000000);
                    var timestamp = new Date().getTime();
                    var ImpNew = Imp;
                    var retryReason;
                    try {
                        retryReason = arguments[0] || '';
                    } catch (ignore) {
                        retryReason = '';
                    }
                    if (ImpNew.indexOf('?') < 0) {
                        ImpNew += '?';
                    }
                    ImpNew = ImpNew.replace('ord=[timestamp]', 'ord=' + timestamp) + '&' + asRandom + '&ftctime=' + timestamp;
                    // MARK: - Alternate http and https for DoubleClick while retrying
                    if (retryTimes > 0) {
                        if (lastImp.indexOf('https') === 0) {
                            ImpNew = ImpNew.replace('https://ad.doubleclick.net', 'http://ad.doubleclick.net');
                            ImpNew = ImpNew.replace('https://v.admaster.com.cn', 'http://v.admaster.com.cn');
                        } else {
                            ImpNew = ImpNew.replace('http://ad.doubleclick.net', 'https://ad.doubleclick.net');
                            ImpNew = ImpNew.replace('http://v.admaster.com.cn', 'https://v.admaster.com.cn');
                        }
                    }
                    lastImp = ImpNew;

                    window.parent.gTrackThirdParyImpression[asRandom] = new Image();
                    window.parent.gTrackThirdParyImpression[asRandom].src = ImpNew;
                    window.parent.gTrackThirdParyImpression[asRandom].title = AdName + ' (' + AssID + ')';
                    window.parent.gTrackThirdParyImpression[asRandom].alt = Imp;

                    window.parent.gTrackThirdParyImpression[asRandom].onload = function() {
                        var actionName = '';
                        if (retryTimes === 0) {
                            actionName = 'Success';
                        } else if (retryReason !== '') {
                            actionName = 'Success on Retry' + retryReason;
                        } else {
                            actionName = 'Success on Retry' + retryTimes;
                        }
                        sendEvent(this.title, actionName, this.alt);
                        delete window.parent.gTrackThirdParyImpression[asRandom];
                        isRequestSuccessful = true;
                    };

                    window.parent.gTrackThirdParyImpression[asRandom].onerror = function() {
                        var failActionName = '';
                        if (retryTimes === 0) {
                            failActionName = 'Fail';
                        } else if (retryReason !== '') {
                            failActionName = 'Fail on Retry' + retryReason;
                        } else {
                            failActionName = 'Fail on Retry' + retryTimes;
                        }
                        sendEvent(this.title, failActionName, this.alt);
                        sendEvent('Fail UA String', AssID, window.parent.adReachability());

                        if (typeof window.uaString === 'string') {
                            //MAKR: Baidu Analytics
                            try {
                                window.parent._hmt.push(['_trackEvent', this.title, 'Fail', window.uaString]);
                            } catch (ignore) {

                            }
                        }
                        retryTimes++;
                        if (retryTimes <= retryTimeLimit) {
                            setTimeout(sendOnetime, 100 * retryTimes * retryTimes * retryTimes);
                        }
                    };
                };
                sendOnetime();

                // MARK: if the request is not successful in 10 seconds, try for the last time
                setTimeout(function() {
                    if (isRequestSuccessful === false && retryTimes === 0) {
                        retryTimes = retryTimeLimit - 1;
                        var retryReason2 = ' from Pending';
                        sendOnetime(retryReason2);
                        sendEvent(AdName + ' (' + AssID + ')', 'Request' + retryReason2, Imp);
                    }
                }, 10000);
                // MARK: send request for all
                sendEvent(AdName + ' (' + AssID + ')', 'Request', Imp);
            }
        }

        if (typeof window.parent.sendImpToThirdParty === 'function') {
            window.parent.sendImpToThirdParty(Imp, AdName, '[ASSID]');
        } else {
            sendImpToThirdParty(Imp, AdName, '[ASSID]');
        }
    }
</script>