<script type="text/javascript">
    var vid = '[[name=CC视频vid,type=textfield,allowblank=false,width=250]]';

    var siteid = '922662811F1A49E9';

    var v_width = '[[name=视频width,type=textfield,allowblank=false,width=50,default=300]]';

    var v_height = '[[name=视频height,type=textfield,allowblank=false,width=50,default=250]]';

    var opacity = 0;

    var Imp = '[[name=第三方监测,type=textfield,allowblank=true,width=250]]';

    var AdName = '[[name=广告命名,width=250,type=textfield,allowblank=true]]';

    var AssID = '[ASSID]';

    var useragent;
    if (typeof uaString === 'string') {
        if (/iphone/i.test(uaString)) {
            useragent = 'iPhone';
        } else if (/ipad/i.test(uaString)) {
            useragent = 'iPad';
        } else if (/android/i.test(uaString)) {
            useragent = 'Android';
        } else {
            useragent = 'iPhone';
        }
    } else {
        useragent = 'iPhone';
    }

    var gaServerTracker = new Image();
    gaServerTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/2?ec=' + AdName + ' (' + AssID + ')' + '&ea=initiate&el=' + Imp + '&' + Math.random();

    document.write('<div style="width:' + v_width + 'px; height:' + v_height + 'px; display:block; overflow:hidden">');
    document.write('<div id="video"></div>');

    document.write('<a style="cursor:pointer; width:1px; height:1px; display:block;" href="[URL]" target="_blank"><div style="width:300px; height:70px; position:relative; top:-250px; left:0px; z-index:10; background-color:#FFF; filter:alpha(opacity=' + opacity + '); -moz-opacity:' + opacity + '; opacity:' + opacity + '; cursor:pointer; border:none; padding:0px; margin:0px"></div></a></div>');
    document.write('<a style="cursor:pointer; width:1px; height:1px; display:block;" href="[URL]" target="_blank"><div style="width:300px; height:70px; position:relative; top:-100px; left:0px; z-index:10; background-color:#FFF; filter:alpha(opacity=' + opacity + '); -moz-opacity:' + opacity + '; opacity:' + opacity + '; cursor:pointer; border:none; padding:0px; margin:0px"></div></a></div>');
    document.write('<a style="cursor:pointer; width:1px; height:1px; display:block;" href="[URL]" target="_blank"><div style="width:100px; height:220px; position:relative; top:-250px; left:0px; z-index:10; background-color:#FFF; filter:alpha(opacity=' + opacity + '); -moz-opacity:' + opacity + '; opacity:' + opacity + '; cursor:pointer; border:none; padding:0px; margin:0px"></div></a></div>');
    document.write('<a style="cursor:pointer; width:1px; height:1px; display:block;" href="[URL]" target="_blank"><div style="width:100px; height:220px; position:relative; top:-250px; left:200px; z-index:10; background-color:#FFF; filter:alpha(opacity=' + opacity + '); -moz-opacity:' + opacity + '; opacity:' + opacity + '; cursor:pointer; border:none; padding:0px; margin:0px"></div></a></div>');

    var JSONP = document.createElement('script');
    JSONP.type = 'text/javascript';
    JSONP.src = 'http://p.bokecc.com/servlet/getvideofile?vid=' + vid + '&siteid=' + siteid + '&divid=&callback=video&useragent=' + useragent;
    document.getElementsByTagName('head')[0].appendChild(JSONP);

    function video(obj) {
        document.getElementById('video').innerHTML = '<video src="' + obj.copies[0].playurl + '" width="' + v_width + '" height="' + v_height + '" airplay="deny" x-webkit-airplay="deny" playsinline webkit-playsinline>Your browser does not support the <code>video</code> element.</video>';
        var v = document.getElementsByTagName('video')[0];
        v.controls = true;
        v.volume = 0;
        v.muted = true;
        v.poster = obj.img;
    }

    function sendImpToThirdParty(Imp, AdName, AssID) {
        if (typeof Imp === 'string') {
            if (typeof window.parent.gTrackThirdParyImpression !== 'object') {
                window.parent.gTrackThirdParyImpression = {};
            }
            var retryTimes = 0;
            var lastImp = Imp;
            var isRequestSuccessful = false;
            var retryTimeLimit = 3;
            var sendEvent = function() {
                var eventCategory = arguments[0] || '';
                var eventAction = arguments[1] || '';
                var eventLabel = arguments[2] || '';
                try {
                    window.parent.ga('send', 'event', eventCategory, eventAction, eventLabel, {
                        'nonInteraction': 1
                    });
                } catch (ignore) {
                    var gaServerTracker = new Image();
                    gaServerTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/2?ec=' + eventCategory + '&ea=' + eventAction + '&el=' + eventLabel;
                    if (eventAction === 'request') {
                        var topUrl = top.location.href;
                        var topUrlTracker = new Image();
                        topUrlTracker.src = 'http://www.ftchinese.com/index.php/ft/hit/' + AssID + '/1?url=' + encodeURIComponent(topUrl);
                    }
                }
            };
            var sendOnetime = function() {
                var asRandom = 'IMG' + Math.round(Math.random() * 1000000000000);
                var timestamp = new Date().getTime();
                var ImpNew = Imp;
                var retryReason;
                try {
                    retryReason = arguments[0] || '';
                } catch (ignore) {
                    retryReason = '';
                }
                if (ImpNew.indexOf('?') < 0) {
                    ImpNew += '?';
                }
                ImpNew = ImpNew.replace('ord=[timestamp]', 'ord=' + timestamp) + '&' + asRandom + '&ftctime=' + timestamp;
                // MARK: - Alternate http and https for DoubleClick while retrying
                if (retryTimes > 0) {
                    if (lastImp.indexOf('https') === 0) {
                        ImpNew = ImpNew.replace('https://ad.doubleclick.net', 'http://ad.doubleclick.net');
                        ImpNew = ImpNew.replace('https://v.admaster.com.cn', 'http://v.admaster.com.cn');
                    } else {
                        ImpNew = ImpNew.replace('http://ad.doubleclick.net', 'https://ad.doubleclick.net');
                        ImpNew = ImpNew.replace('http://v.admaster.com.cn', 'https://v.admaster.com.cn');
                    }
                }
                lastImp = ImpNew;

                window.parent.gTrackThirdParyImpression[asRandom] = new Image();
                window.parent.gTrackThirdParyImpression[asRandom].src = ImpNew;
                window.parent.gTrackThirdParyImpression[asRandom].title = AdName + ' (' + AssID + ')';
                window.parent.gTrackThirdParyImpression[asRandom].alt = Imp;

                window.parent.gTrackThirdParyImpression[asRandom].onload = function() {
                    var actionName = '';
                    if (retryTimes === 0) {
                        actionName = 'Success';
                    } else if (retryReason !== '') {
                        actionName = 'Success on Retry' + retryReason;
                    } else {
                        actionName = 'Success on Retry' + retryTimes;
                    }
                    sendEvent(this.title, actionName, this.alt);
                    delete window.parent.gTrackThirdParyImpression[asRandom];
                    isRequestSuccessful = true;
                };

                window.parent.gTrackThirdParyImpression[asRandom].onerror = function() {
                    var failActionName = '';
                    if (retryTimes === 0) {
                        failActionName = 'Fail';
                    } else if (retryReason !== '') {
                        failActionName = 'Fail on Retry' + retryReason;
                    } else {
                        failActionName = 'Fail on Retry' + retryTimes;
                    }
                    sendEvent(this.title, failActionName, this.alt);
                    sendEvent('Fail UA String', AssID, window.parent.adReachability());

                    if (typeof window.uaString === 'string') {
                        //MAKR: Baidu Analytics
                        try {
                            window.parent._hmt.push(['_trackEvent', this.title, 'Fail', window.uaString]);
                        } catch (ignore) {

                        }
                    }
                    retryTimes++;
                    if (retryTimes <= retryTimeLimit) {
                        setTimeout(sendOnetime, 100 * retryTimes * retryTimes * retryTimes);
                    }
                };
            };
            sendOnetime();

            // MARK: if the request is not successful in 10 seconds, try for the last time
            setTimeout(function() {
                if (isRequestSuccessful === false && retryTimes === 0) {
                    retryTimes = retryTimeLimit - 1;
                    var retryReason2 = ' from Pending';
                    sendOnetime(retryReason2);
                    sendEvent(AdName + ' (' + AssID + ')', 'Request' + retryReason2, Imp);
                }
            }, 10000);
            // MARK: send request for all
            sendEvent(AdName + ' (' + AssID + ')', 'Request', Imp);
        }
    }

    if (typeof window.parent.sendImpToThirdParty === 'function') {
        window.parent.sendImpToThirdParty(Imp, AdName, AssID);
    } else {
        sendImpToThirdParty(Imp, AdName, AssID);
    }
</script>